title: "Maturity at age Analysis"
author: "Anna Conklyn"
date: "2/28/2021"
output: html_document
---

# **Structure and Condition of an Established Round Goby Population in the Thousand Islands Region, St. Lawrence River**
## *Maturity at age analysis*

### Contents of Rmarkdown:
  > 1. Maturity at age proportion table creation & proportion mature vs. age plot

  > 2. Logistic regression model fitting
        
  > 3. Compute age-at-50% and 90% maturity
  
  > 4. Statistical comparisons
  

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(readxl)
library(FSA)
library(car)
library(plyr)
library(tidyr)
library(dplyr)
library(magrittr)

```


```{r, include=FALSE}
setwd("G:/POP_STRUCTURE_PUB/Data/Maturity")
AllRG<- read_excel("Maturity.xlsx", col_names = TRUE)

AllRG<- na.omit(AllRG)
AllRG %>% group_by(Site)
AllRG$Age<- as.numeric(AllRG$Age)
AllRG$Maturity<- as.factor(AllRG$Maturity)
AllRG$Maturity1<-ifelse(AllRG$Maturity=="Mature",1,0)
```

```{r, include=FALSE}
#Filter sexes and sites
RG.C<- AllRG %>% filter(Site == "Cobb")
RG.R<- AllRG %>% filter(Site == "Rose")

RG.M<-AllRG %>% filter(Sex=="M")
RG.M.C<- RG.M %>% filter(Site == "Cobb")
RG.M.R<- RG.M %>% filter(Site == "Rose")

RG.F<-AllRG %>% filter(Sex=="F")
RG.F.C<- RG.F %>% filter(Site == "Cobb")
RG.F.R<- RG.F %>% filter(Site == "Rose")

RG.F.R<- na.omit(RG.F.R)
as.data.frame(RG.F.R)
```



## 1. Maturity at age proportion table creation

### Sexes combined
#### Cobb

```{r, echo=FALSE}
C_Table<- with(RG.C, table(Age, Maturity))
(C_prop_age<- prop.table(C_Table, margin = 1))

lens <- as.numeric(rownames(C_prop_age))
plot(C_prop_age[,"Mature"]~lens,pch=16,xlab="Age",ylab="Proportion Mature")
```

### Sexes combined
#### Rose

```{r, echo=FALSE}
R_Table<- with(RG.R, table(Age, Maturity))
(R_prop_age<- prop.table(R_Table, margin = 1))

lens <- as.numeric(rownames(R_prop_age))
plot(R_prop_age[,"Mature"]~lens,pch=16,xlab="Age",ylab="Proportion Mature")
```

### Sites combined
#### Male

```{r, echo=FALSE}
M_Table<- with(RG.M, table(Age, Maturity))
(M_prop_age<- prop.table(M_Table, margin = 1))

lens <- as.numeric(rownames(M_prop_age))
plot(M_prop_age[,"Mature"]~lens,pch=16,xlab="Age",ylab="Proportion Mature")
```

#### Female

```{r, echo=FALSE}
F_Table<- with(RG.F, table(Age, Maturity))
(F_prop_age<- prop.table(F_Table, margin = 1))

lens <- as.numeric(rownames(F_prop_age))
plot(F_prop_age[,"Mature"]~lens,pch=16,xlab="Age",ylab="Proportion Mature")
```


### Male RG

#### Cobb

```{r, echo=FALSE}
M_C_Table<- with(RG.M.C, table(Age, Maturity))
(M_C_prop_age<- prop.table(M_C_Table, margin = 1))

lens <- as.numeric(rownames(M_C_prop_age))
plot(M_C_prop_age[,"Mature"]~lens,pch=16,xlab="Age",ylab="Proportion Mature")
```

#### Rose

```{r, echo=FALSE}
M_R_Table<- with(RG.M.R, table(Age, Maturity))
(M_R_prop_age<- prop.table(M_R_Table, margin = 1))

lens <- as.numeric(rownames(M_R_prop_age))
plot(M_R_prop_age[,"Mature"]~lens,pch=16,xlab="Age",ylab="Proportion Mature")
```

### Femle RG

#### Cobb

```{r, echo=FALSE}
F_C_Table<- with(RG.F.C, table(Age, Maturity))
(F_C_prop_age<- prop.table(F_C_Table, margin = 1))

lens <- as.numeric(rownames(F_C_prop_age))
plot(F_C_prop_age[,"Mature"]~lens,pch=16,xlab="Age",ylab="Proportion Mature")
```

#### Rose

```{r, echo=FALSE}
F_R_Table<- with(RG.F.R, table(Age, Maturity))
(F_R_prop_age<- prop.table(F_R_Table, margin = 1))

lens <- as.numeric(rownames(F_R_prop_age))
plot(F_R_prop_age[,"Mature"]~lens,pch=16,xlab="Age",ylab="Proportion Mature")
```


## 2. Logistic regression model fitting

### Sexes combined
#### Cobb

```{r, echo=FALSE}
glm_C <- glm(Maturity1~Age,data=RG.C,family=binomial)
coef(glm_C)

##Bootstrap coefficients
b_glm_C<- Boot(glm_C, f=coef, R=1000)
confint(b_glm_C)
```

#### Rose

```{r, echo=FALSE}
glm_R <- glm(Maturity1~Age,data=RG.R,family=binomial)
coef(glm_R)

##Bootstrap coefficients
b_glm_C<- Boot(glm_C, f=coef, R=1000)
confint(b_glm_C)
```

### Sites combined
#### Male

```{r, echo=FALSE}
glm_M <- glm(Maturity1~Age,data=RG.M,family=binomial)
coef(glm_M)

##Bootstrap coefficients
b_glm_M<- Boot(glm_M, f=coef, R=1000)
confint(b_glm_M)
```

#### Female

```{r, echo=FALSE}
glm_F <- glm(Maturity1~Age,data=RG.F,family=binomial)
coef(glm_F)

##Bootstrap coefficients
b_glm_F<- Boot(glm_F, f=coef, R=1000)
confint(b_glm_F)
```

### Male RG

#### Cobb

```{r, echo=FALSE}
glm_M_C <- glm(Maturity1~Age,data=RG.M.C,family=binomial)
coef(glm_M_C)

##Bootstrap coefficients
b_glm_M_C<- Boot(glm_M_C, f=coef, R=1000)
confint(b_glm_M_C)
```

#### Rose

```{r, echo=FALSE}
glm_M_R <- glm(Maturity1~Age,data=RG.M.R,family=binomial)
coef(glm_M_R)

##Bootstrap coefficients
b_glm_M_R<- Boot(glm_M_R, f=coef, R=1000)
confint(b_glm_M_R)
```


### Female RG

#### Cobb

```{r, echo=FALSE}
glm_F_C <- glm(Maturity1~Age,data=RG.F.C,family=binomial)
coef(glm_F_C)

##Bootstrap coefficients
b_glm_F_C<- Boot(glm_F_C, f=coef, R=1000)
confint(b_glm_F_C)
```

#### Rose

```{r, echo=FALSE}
(glm_F_R <- glm(Maturity1~Age,data=RG.F.R,family=binomial))
(coef(glm_F_R))

##Bootstrap coefficients
(b_glm_F_R<- Boot(glm_F_R, f=coef, R=1000))
confint(b_glm_F_R)
summary(b_glm_F_R)
```




## 3. Compute age-at- 50% maturity

Use 

$$ x = \frac {log (\frac{p}{1-p}) - \alpha} {\beta_1} $$

```{r, echo=FALSE}
## percentage formula

lrPerc <- function(cf,p) (log(p/(1-p))-cf[1])/cf[2]
```

### Sexes combined
#### Cobb
```{r, echo=FALSE}
(C_L50 <- lrPerc(coef(glm_C),0.5))
(C_L90 <- lrPerc(coef(glm_C),0.9))
```

### Rose
```{r, echo=FALSE}
(R_L50 <- lrPerc(coef(glm_R),0.5))
(R_L90 <- lrPerc(coef(glm_R),0.9))
```

### Sites combined
#### Males
```{r, echo=FALSE}
(M_L50 <- lrPerc(coef(glm_M),0.5))
(M_L90 <- lrPerc(coef(glm_M),0.9))
```

#### Females
```{r, echo=FALSE}
(F_L50 <- lrPerc(coef(glm_F),0.5))
(F_L90 <- lrPerc(coef(glm_F),0.9))
```

### Male RG

#### Cobb

```{r, echo=FALSE}
(M_C_L50 <- lrPerc(coef(glm_M_C),0.5))
(M_C_L90 <- lrPerc(coef(glm_M_C),0.9))
```

#### Rose
```{r, echo=FALSE}
(M_R_L50 <- lrPerc(coef(glm_M_R),0.5))
(M_R_L90 <- lrPerc(coef(glm_M_R),0.9))


```

### Female RG

#### Cobb
```{r, echo=FALSE}
(F_C_L50 <- lrPerc(coef(glm_F_C),0.5))
(F_C_L90 <- lrPerc(coef(glm_F_C),0.9))
```

#### Rose
```{r, echo=FALSE}
(F_R_L50 <- lrPerc(coef(glm_F_R),0.5))
(F_R_L90 <- lrPerc(coef(glm_F_R),0.9))
```


## 4. Statistical comparisons

### Site comparison

```{r}
glm_sites<- glm(Maturity~Age*Site, data = AllRG, family=binomial)
drop1(glm_sites,~.,test="Chisq")
cf_Sites<- coef(glm_sites)

Site_Age_Matuirty_table<- tbl_regression(glm_sites) %>% add_glance_table(
    include = c(nobs, logLik, AIC, BIC)) %>%  as_gt()
Site_Age_Matuirty_table %>% gtsave(filename="Site_Age_Matuirty_table.png", path="G:/POP_STRUCTURE_PUB/Figures")
```

```{r}
x <- seq(0,5,1)
pC <- exp(cf_Sites[1]+cf_Sites[2]*x)/(1+exp(cf_Sites[1]+cf_Sites[2]*x))
pR<- exp(cf_Sites[1]+cf_Sites[3]+(cf_Sites[2]+cf_Sites[4])*x)/(1+exp(cf_Sites[1]+cf_Sites[3]+(cf_Sites[2]+cf_Sites[4])*x))
```

```{r}
plot(pC~x,type="l",lwd=2,xlab="Age",ylab="Proportion Mature",  ylim=c(0,1))
lines(pR~x,type="l",lwd=2,col="red")
legend("bottomright",c("Cobb","Rose"),lwd=2,col=c("black","red"),bty="n")

Maturity_age_plot<- ggplot(AllRG, aes(x=Age, y=Maturity1, color=Site)) + geom_point(aes(color=Site)) + 
  stat_smooth(method="glm", method.args=list(family="binomial"), se=FALSE) + theme_classic () + scale_colour_manual(values=c("black", "grey")) + labs(x= "Age", y="Probability of maturity")
ggsave("Maturity_age.jpeg", device="jpeg", plot=Maturity_age_plot, path="G:/POP_STRUCTURE_PUB/Figures", dpi="retina", width = 7.48031, height = 5)
```



### Sex comparison

```{r}
glm_sexes<- glm(Maturity~Age*Sex, data = AllRG, family=binomial)
drop1(glm_sexes,~.,test="Chisq")
cf_sexes<- coef(glm_sexes)
```

```{r}
xM <- seq(0,5,1)
xF<- seq(0,5,1)
pM <- exp(cf_sexes[1]+cf_sexes[2]*xM)/(1+exp(cf_sexes[1]+cf_sexes[2]*xM))
pF<- exp(cf_sexes[1]+cf_sexes[3]+(cf_sexes[2]+cf_sexes[4])*xF)/(1+exp(cf_sexes[1]+cf_sexes[3]+(cf_sexes[2]+cf_sexes[4])*xF))
```

```{r}
plot(pM~xM,type="l",lwd=2,xlab="Age",ylab="Proportion Mature",  ylim=c(0,1))
lines(pF~xF,type="l",lwd=2,col="red")
legend("bottomright",c("Male","Female"),lwd=2,col=c("black","red"),bty="n")
```

### Male site comparison

```{r}
glm_male<- glm(Maturity~Age*Site, data = RG.M, family=binomial)
drop1(glm_male,~.,test="Chisq")
cf_m<- coef(glm_male)
```

```{r}
x <- seq(0,5,1)
pC <- exp(cf_m[1]+cf_m[2]*x)/(1+exp(cf_m[1]+cf_m[2]*x))
pR<- exp(cf_m[1]+cf_m[3]+(cf_m[2]+cf_m[4])*x)/(1+exp(cf_m[1]+cf_m[3]+(cf_m[2]+cf_m[4])*x))
```

```{r}
plot(pC~x,type="l",lwd=2,xlab="Age",ylab="Proportion Mature",  ylim=c(0,1))
lines(pR~x,type="l",lwd=2,col="red")
legend("bottomright",c("Cobb","Rose"),lwd=2,col=c("black","red"),bty="n")
```


### Female site comparison

```{r}
glm_female<- glm(Maturity~Age*Site, data = RG.F, family=binomial)
drop1(glm_female,~.,test="Chisq")
cf_f<- coef(glm_female)
```

```{r}
x <- seq(0,5,1)
pC_f <- exp(cf_f[1]+cf_f[2]*x)/(1+exp(cf_f[1]+cf_f[2]*x))
pR_f<- exp(cf_f[1]+cf_f[3]+(cf_f[2]+cf_f[4])*x)/(1+exp(cf_f[1]+cf_f[3]+(cf_f[2]+cf_f[4])*x))
```

```{r}
plot(pC_f~x,type="l",lwd=2,xlab="Age",ylab="Proportion Mature", ylim=c(0,1))
lines(pR_f~x,type="l",lwd=2,col="red")
legend("bottomright",c("Cobb","Rose"),lwd=2,col=c("black","red"),bty="n")
```