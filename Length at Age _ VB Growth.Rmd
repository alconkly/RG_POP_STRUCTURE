---
title: "Length at Age & VB Growth "
author: "Anna Conklyn"
date: "9/26/2022"
output: html_document
---

# **Structure and Condition of an Established Round Goby Population in the Thousand Islands Region, St. Lawrence River**
## *Length at Age and Von Bertalanffy growth of observed data*

### Contents of Rmarkdown:
  > 1. Length at age models for each combination of sex and site 
  > 2. Von Bertalanffy growth curves
  > 3. 
Install packages

```{r setup, include=FALSE}
library(FSA)
library(nlstools)
library(magrittr)
library(dplyr)
library(plotrix)
library(nnet)
library(nls2)
library(ggpubr)
library(rlang)
library(ggpubr)
library(sjPlot)
library(gt)
library(gridExtra)
library(grid)
library(patchwork)
library(kableExtra)
library(gtsummary)
library(webshot)
library(readxl)
library(lmtest)
library(FSAmisc)
```



```{r, include=FALSE}
#Load data

getwd()
setwd("G:/Dissertation/Chapter 2- pop structure/RG_POP_STRUCTURE")
RG <- read_excel("Pop_Strucutre_Dissected.xlsx") 
```


```{r, include=FALSE}
##5mm length categories; remove unaged

RG %<>% mutate(lcat5=lencat(Total.Length, w=5)) %<>% filter(!is.na(RG$Age))

headtail(RG)

Male<- filter(RG, Sex== "M")
Female<- filter(RG, Sex=="F")
```


## 1. Length at age models for each combination of sex and site
#### Likelihood ratio tests to determine if age length keys are different 

### All combined round gobies; LRT for differences between sexes and sites

```{r, echo=FALSE}
(alk.freq<- xtabs(~lcat5+Age, data=RG))
alk.prop<- (prop.table(alk.freq))
round(alk.prop, 3)
len<- xtabs(~lcat5, data=RG)

alkMeanVar(alk.freq, Total.Length~lcat5+Age, data=RG, len.n = len)

mod1 <- multinom(Age~lcat5,data=RG,maxit=500)
mod2 <- multinom(Age~lcat5*Sex,data=RG,maxit=500)
Sex_ALK_ANOVA<- anova(mod1,mod2)  ##No observed differences between sexes for age-length keys 

mod1 <- multinom(Age~lcat5,data=RG,maxit=500)
mod2 <- multinom(Age~lcat5*Site,data=RG,maxit=500)
Site_ALK_ANOVA<- anova(mod1,mod2)  ##Significant differences between sites for age-length keys 

ALK_ANOVA<- rbind(Sex_ALK_ANOVA, Site_ALK_ANOVA)

(ALK_ANOVA_Table<- gt(ALK_ANOVA) %>% cols_hide("Test") %>% fmt_number(columns = c("Resid. Dev" , "LR stat.", "Pr(Chi)"),  decimals = 2) %>% 
  tab_style(
    style = cell_text( weight = "bold", align = "left"),
    locations = cells_group()) %>% 
  tab_style(
    style = cell_text( weight = "bold", align = "left"),
    locations = cells_column_labels()
  ))
```


### Male round gobies; LRT for differences between sites 

```{r, echo=FALSE}
(alk.freq.M<- xtabs(~lcat5+Age, data=Male))
alk.prop.M<- (prop.table(alk.freq.M))
round(alk.prop.M, 3)
len.M<- xtabs(~lcat5, data=Male)

alkMeanVar(alk.freq.M, Total.Length~lcat5+Age, data=Male, len.n = len.M)

Mmod1 <- multinom(Age~lcat5,data=Male,maxit=500)
Mmod2 <- multinom(Age~lcat5*Site,data=Male,maxit=500)

Male_Site_ALK_ANOVA<-anova(Mmod1,Mmod2) ## Significant differences between sites among male round gobies
Male_Site_ALK_ANOVA$Sex<- "Male"
```


### Female round gobies; LRT for differences between sites

```{r, echo=FALSE}
(alk.freq.F<- xtabs(~lcat5+Age, data=Female))
alk.prop.F<- (prop.table(alk.freq.F))
round(alk.prop.F, 3)
len.F<- xtabs(~lcat5, data=Female)

alkMeanVar(alk.freq.F, Total.Length~lcat5+Age, data=Female, len.n = len.F)

Fmod1 <- multinom(Age~lcat5,data=Female,maxit=500)
Fmod2 <- multinom(Age~lcat5*Site,data=Female,maxit=500)
Female_Site_ALK_ANOVA<-anova(Fmod1,Fmod2) ##No observed differences between sites among female round gobies
Female_Site_ALK_ANOVA$Sex<- "Female"
```

```{r, echo=FALSE}
ALK_ANOVA_separated<- rbind(Male_Site_ALK_ANOVA, Female_Site_ALK_ANOVA)

(ALK_ANOVA_separated_Table<- gt(ALK_ANOVA_separated, groupname_col = "Sex") %>% cols_hide("Test") %>% fmt_number(columns = c("Resid. Dev" , "LR stat.", "Pr(Chi)"),  decimals = 2) %>% 
  tab_style(
    style = cell_text( weight = "bold", align = "left"),
    locations = cells_group()) %>% 
  tab_style(
    style = cell_text( weight = "bold", align = "left"),
    locations = cells_column_labels()
  ))
  
```


## 2. Von Bertalanffy growth curves

```{r, set up fnctions}

vbLKt <- Total.Length~Linf[Site]*(1-exp(-K[Site]*(Age-t0[Site])))
vbLK <- Total.Length~Linf[Site]*(1-exp(-K[Site]*(Age-t0)))
vbLt <- Total.Length~Linf[Site]*(1-exp(-K*(Age-t0[Site])))
vbKt <- Total.Length~Linf*(1-exp(-K[Site]*(Age-t0[Site])))
vbL <- Total.Length~Linf[Site]*(1-exp(-K*(Age-t0)))
vbK <- Total.Length~Linf*(1-exp(-K[Site]*(Age-t0)))
vbt <- Total.Length~Linf*(1-exp(-K*(Age-t0[Site])))
vbO <- Total.Length~Linf*(1-exp(-K*(Age-t0)))

```

### Male Von Bertalanffy

### Male growth site comparison

```{r, echo=FALSE}
Male$Site<- as.factor(Male$Site)

(MVB <- vbStarts(Total.Length~Age,data=Male))
(MaleLKt<- Map(rep, MVB, c(2,2,2)))

MfitLKt <- nls(vbLKt,data=Male,start=MaleLKt)
summary(MfitLKt)

Mfit0 <- nls(vbO,data=Male,start=MaleLKt)
summary(Mfit0)

loglik0<- logLik(Mfit0)
loglikF<- logLik(MfitLKt)

lrt<- lrtest(Mfit0, MfitLKt) ## Conlcusion- there is a significant differences parameters between sites
Mtest_table<- cbind(loglik0, loglikF, lrt)
Mtest_table<- Mtest_table[2,c(1,2,5,6,7)] %>% round(3)
Mtest_table$Sex<- "Male"
  
```


### Fitting male Von Bertalanffy models for Rose and Cobb, and summarizing model fit

```{r, Rose fit}
##Rose
vbTyp <- vbFuns("typical")
rgMr<- filter(Male, Site=="Rose")
rgMr$Total.Length<- as.numeric(rgMr$Total.Length)

fitMr<- nls(Total.Length~vbTyp(Age, Linf, K, t0), data=rgMr, start=MVB)
bMr <- nlsBoot(fitMr)
cbind(coef(fitMr),confint(bMr))
(MR_VBSum<- summary(fitMr))
residPlot(fitMr)

```


```{r, Cobb fit}
##Cobb
rgMc<- filter(Male, Site=="Cobb")
rgMc$Length<- as.numeric(rgMc$Total.Length)

fitMc<- nls(Total.Length~vbTyp(Age, Linf, K, t0), data=rgMc, start=MVB)
bMc <- nlsBoot(fitMc)
cbind(coef(fitMr),confint(bMc))
(MC_VBSum<- summary(fitMc))
residPlot(fitMc)
```


```{r, Summary of model parameters}
MVB<-rbind(fitMc,fitMr)

(MrVB_Table<- tbl_regression(fitMr)%>%  
  add_significance_stars(hide_p = FALSE, pattern = "{p.value}") %>%
  add_glance_table(
    include = c(nobs, logLik, AIC, BIC))  )

(McVB_Table<- tbl_regression(fitMc) %>%  
  add_significance_stars(hide_p = FALSE,  pattern = "{p.value}") %>%
  add_glance_table(
    include = c(nobs, logLik, AIC, BIC)))
    ```


### Male plotting

```{r}
##Rose predictions
xr<- seq(min(rgMr$Age), max(rgMr$Age), length.out=199)
pr<- vbTyp(xr, Linf=coef(fitMr))
roseMVB<-as.data.frame(cbind(xr,pr))

##Cobb predictions
xc<- seq(min(rgMc$Age), max(rgMc$Age), length.out=199)
pc<- vbTyp(xc, Linf=coef(fitMc))
cobbMVB<- as.data.frame(cbind(xc, pc))

```


```{r}
(MaleVBPlot1<- ggplot(data=Male, aes(color=Site))+geom_point(aes(x=Age, y=Total.Length, shape=Site))+ scale_color_manual(values = c("Rose"= "black","Cobb"="grey"))  + theme_classic ()  + labs(x = "Age",  y = "Total Length (mm)") + ylim(50,230) + theme(plot.margin = margin(t=0.1, l=0.1, r=0.1, b=0.1, unit = "cm"), text = element_text(size = 15), legend.position = "bottom") + geom_line(data=roseMVB, aes(x=xr, y=pr), colour=I("black")) + ggtitle("Male") + geom_line(data=cobbMVB,aes(x=xc, y=pc), colour=I("gray")))

ggsave("M_VBGrowth.jpeg", device="jpeg", plot=MaleVBPlot1, path="G:/POP_STRUCTURE_PUB/Figures", dpi="retina", width = 7.48031, height = 5)
```


### Female Von Bertalanffy

### Female growth site comparison

```{r, echo=FALSE}
Female$Site<- as.factor(Female$Site)
(FVB <- vbStarts(Total.Length~Age,data=Female))
(FemaleLKt<- Map(rep, FVB, c(2,2,2)))

Ffit0 <- nls(vbO,data=Female,start=FVB)
summary(Ffit0)

FfitLKt <- nls(vbLK,data=Female,start=FemaleLKt)
summary(FfitLKt)

loglik0<- logLik(Ffit0)
loglikF<- logLik(FfitLKt)

(lrt<- lrtest(Ffit0, FfitLKt))
Ftest_table<- cbind(loglik0, loglikF, lrt)
Ftest_table<- Ftest_table[2,c(1,2,5,6,7)] %>% round(3)
Ftest_table$Sex<- "Female"
  
```


### Fitting female Von Bertalanffy models for Rose and Cobb, and summarizing model fit

```{r, Rose fit}
##Rose

rgFr<- filter(Female, Site=="Rose")
rgFr$Total.Length<- as.numeric(rgFr$Total.Length)

fitFr<- nls(Total.Length~vbTyp(Age, Linf, K, t0), data=rgFr, start=FVB)
bFr <- nlsBoot(fitFr)
cbind(coef(fitFr),confint(bFr))
(FR_VBSum<- summary(fitFr))
residPlot(fitFr)

```


```{r, Cobb fit}
##Cobb

rgFc<- filter(Female, Site=="Cobb")
rgFc$Total.Length<- as.numeric(rgFc$Total.Length)

#fitFc<- nls(Total.Length~vbTyp(Age, Linf, K, t0), data=rgFc, start=FVB, control=list(maxiter=100,minFactor=1/5000), algorithm="port", lower=list(Linf=1,K=-1,t0=-4), upper=list(Linf=500,K=1,t0=1))
#bFc <- nlsBoot(fitFc)
#cbind(coef(fitFc),confint(bFc))
#FC_VBSum<- summary(fitFc)

```

#Joined females
```{r}


fitF<- nls(Total.Length~vbTyp(Age, Linf, K, t0), data=Female, start=FVB)
bF <- nlsBoot(fitF)
cbind(coef(fitF),confint(bF))
(F_VBSum<- summary(fitF))
residPlot(fitFr)

(F_VB_Table<- tbl_regression(fitF)%>%  
  add_significance_stars(hide_p = FALSE, pattern = "{p.value}") %>%
  add_glance_table(
    include = c(nobs, logLik, AIC, BIC))  )


##Female predictions
xf<- seq(min(Female$Age), max(Female$Age), length.out=199)
pf<- vbTyp(xf, Linf=coef(fitF))
FemaleVB<- as.data.frame(cbind(xf, pf))


(FemaleVBPlot<- ggplot(data=Female)+geom_point(aes(x=Age, y=Total.Length, color=Site, shape=Site))+ theme_classic () + geom_line(data=FemaleVB, aes(x=xf, y=pf), color="black") + labs(x = "Age",  y = "Total Length (mm)") + ylim(50,230) + scale_color_manual(values = c("Rose" = "black", "Cobb" = "grey")) + ggtitle("Female") +  theme(plot.margin = margin(t=0.1, l=0.1, r=0.1, b=0.1, unit = "cm"), text = element_text(size = 15), legend.position = "bottom")) 

ggsave("F_VBGrowth.jpeg", device="jpeg", plot=FemaleVBPlot, path="G:/POP_STRUCTURE_PUB/Figures", dpi="retina", width = 7.48031, height = 5)
```








```{r, Summary of model parameters}
#FVB<-rbind(fitFr, fitFc)

(FrVB_Table<- tbl_regression(fitFr)%>%  
  add_significance_stars(hide_p = FALSE, pattern = "{p.value}") %>%
  add_glance_table(
    include = c(nobs, logLik, AIC, BIC))  )

#(FcVB_Table<- tbl_regression(fitFc)%>%  
#  add_significance_stars(hide_p = FALSE, pattern = "{p.value}") %>%
#  add_glance_table(
#    include = c(nobs, logLik, AIC, BIC))  )
    ```


### Female plotting

```{r}
##Rose predictions
xfr<- seq(min(rgFr$Age), max(rgFr$Age), length.out=199)
pfr<- vbTyp(xfr, Linf=coef(fitFr))
roseFVB<- as.data.frame(cbind(xfr, pfr))

##Cobb predictions
xfc<- seq(min(rgFc$Age), max(rgFc$Age), length.out=199)

```


```{r}
(FemaleVBPlot<- ggplot(data=Female)+geom_point(aes(x=Age, y=Total.Length, color=Site, shape=Site))+ theme_classic () + geom_line(data=roseFVB, aes(x=xfr, y=pfr), color="black") + labs(x = "Age",  y = "Total Length (mm)") + ylim(50,230) + scale_color_manual(values = c("Rose" = "black", "Cobb" = "grey")) + ggtitle("Female") +  theme(plot.margin = margin(t=0.1, l=0.1, r=0.1, b=0.1, unit = "cm"), text = element_text(size = 15), legend.position = "bottom")) 

ggsave("F_VBGrowth.jpeg", device="jpeg", plot=FemaleVBPlot, path="G:/POP_STRUCTURE_PUB/Figures", dpi="retina", width = 7.48031, height = 5)
```


### Combined summaries- LRT for site differences; figure, parameter table

```{r}
VB_LRT_table<- rbind(Mtest_table, Ftest_table)

VB_LRT_table_print<- VB_LRT_table %>% gt(rowname_col = "Sex") %>% tab_stubhead(label= md("**Sex**")) %>%  cols_label(
    loglik0 = md("**Ln(L<sub>R</sub>)**"),
    loglikF = md("**Ln(L<sub>F</sub>)**"),
         Chisq = md("**X<sup>2</sup>**"),
     "Pr(>Chisq)" = md("**P-value**"),
      Df= md("**df**")
  ) %>%  tab_footnote(
    footnote = md("L<sub>F</sub> denotes maximum likelihood ratio for full model. L<sub>R</sub> denotes maximum likelihood ratio for reduced model."))

VB_LRT_table_print %>% gtsave(filename="VB_LRT_table.png", path="G:/Dissertation/Chapter 2- pop structure/RG_POP_STRUCTURE/Figures")

```



```{r}
(VBFigure <- ggarrange(MaleVBPlot1 + rremove("ylab"), FemaleVBPlot+ rremove("ylab"),
                    nrow = 2, common.legend = TRUE, legend="bottom"))
 annotate_figure(VBFigure, left=text_grob("Total Length (mm)", rot = 90, size = 15))
 
 ggsave("VBGrowth.jpeg", device="jpeg", plot=VBFigure, , path="G:/Dissertation/Chapter 2- pop structure/RG_POP_STRUCTURE/Figures", dpi="retina", width = 7.48031, height = 9)
```


```{r}

(VB_Table<- tbl_merge(
    tbls = list(MrVB_Table, McVB_Table, F_VB_Table),
    tab_spanner = c("**Rose Males**", "**Cobb Males**", "**Females**")
  ) %>% as_gt())
 
 VB_Table %>% gtsave(filename="VB_Parameter_Table.png", path="G:/Dissertation/Chapter 2- pop structure/RG_POP_STRUCTURE/Figures")
 
```
